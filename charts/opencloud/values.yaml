# OpenCloud Helm Chart - Minimal Configuration
#
# This is a streamlined configuration for OpenCloud.
# External dependencies required:
# - OIDC Provider (e.g., Keycloak, Auth0, Okta)
# - S3-compatible storage OR POSIX filesystem with ReadWriteMany support

# =====================================================================
# SECURITY WARNING
# =====================================================================
# IMPORTANT: Change default credentials before deploying to production!
# - opencloud.adminPassword
# - collabora.admin.username and collabora.admin.password
# - External OIDC and S3 credentials

# =====================================================================
# GLOBAL SETTINGS
# =====================================================================

global:
  # Domain settings
  domain:
    # Main OpenCloud domain
    opencloud: cloud.opencloud.test
    # WOPI server domain (for Collabora integration)
    wopi: wopiserver.opencloud.test
    # Collabora CODE domain
    collabora: collabora.opencloud.test

  # TLS configuration
  tls:
    # Enable TLS (disable if using ingress TLS termination)
    enabled: false
    secretName: ""

  # OIDC configuration - REQUIRED
  # You must configure an external OIDC provider
  oidc:
    # OpenID Connect issuer URL
    # Example: https://keycloak.example.com/realms/openCloud
    issuer: ""
    # OIDC client ID
    clientId: "web"
    # OIDC account management URL
    # Example: https://keycloak.example.com/realms/openCloud/account
    accountUrl: ""

  # Storage settings
  storage:
    # Default storage class for PVCs
    storageClass: ""

  # Image settings
  image:
    # Global registry override (optional)
    registry: ""
    # Global pull policy override (optional)
    pullPolicy: ""

# =====================================================================
# UTILITY IMAGES
# =====================================================================

busybox:
  image:
    registry: docker.io
    repository: library/busybox
    tag: "1.36"
    pullPolicy: IfNotPresent

# =====================================================================
# EXTENSIONS
# =====================================================================

# Tika - Full-text search and content extraction
tika:
  enabled: true
  image:
    registry: docker.io
    repository: apache/tika
    tag: "2.9.2.1-full"
    pullPolicy: IfNotPresent
  resources:
    requests:
      cpu: 100m
      memory: 1Gi
    limits:
      cpu: 1000m
      memory: 3Gi

# Web Extensions - Additional functionality for the web interface
webExtensions:
  enabled: true
  image:
    registry: docker.io
    repository: opencloudeu/web-extensions
    pullPolicy: IfNotPresent
  extensions:
    drawio:
      enabled: true
      tag: draw-io-1.0.0
    externalsites:
      enabled: true
      tag: external-sites-1.0.0
    importer:
      enabled: true
      tag: importer-1.0.0
    jsonviewer:
      enabled: true
      tag: json-viewer-1.0.0
    progressbars:
      enabled: true
      tag: progress-bars-1.0.0
    unzip:
      enabled: true
      tag: unzip-1.0.0

# =====================================================================
# COLLABORATION - COLLABORA CODE
# =====================================================================

collabora:
  # Enable Collabora Online (LibreOffice-based document editor)
  enabled: false
  image:
    registry: docker.io
    repository: collabora/code
    tag: 24.04.13.2.1
    pullPolicy: IfNotPresent

  # SSL configuration
  ssl:
    enabled: true
    verification: true

  # Admin credentials
  # Use existingSecret to provide credentials from an existing secret
  # Secret must contain keys: username, password
  existingSecret: ""
  admin:
    username: admin
    password: admin

  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 1
      memory: 1Gi

# =====================================================================
# OPENCLOUD CORE
# =====================================================================

image:
  registry: docker.io
  repository: opencloudeu/opencloud-rolling
  tag: "2.1.0"
  pullPolicy: IfNotPresent
  pullSecrets: []

opencloud:
  enabled: true

  # Scaling configuration
  # Note: Multiple replicas require either:
  # - storage.mode: s3 with external S3, OR
  # - storage.mode: posixfs with ReadWriteMany storage class
  replicas: 1

  # Logging
  logLevel: info
  logColor: false
  logPretty: false

  # Security
  # Set to true to allow self-signed certificates
  insecure: true

  # Admin password
  # Use existingSecret to provide password from existing secret
  # Secret must contain key: adminPassword
  existingSecret: ""
  adminPassword: admin

  # Demo users
  createDemoUsers: false

  # Service configuration
  additionalServices: []
  excludeServices:
    - "idp"  # IDP service excluded (using external OIDC)

  # Environment variables
  env: []
  envFrom: []

  # Resource allocation
  resources:
    requests:
      cpu: 128m
      memory: 128Mi
    limits:
      memory: 20Gi

  # ===================================================================
  # PERSISTENCE
  # ===================================================================

  persistence:
    # Config volume
    config:
      enabled: true
      existingClaim: ""
      size: 5Gi
      storageClass: ""
      accessMode: ReadWriteOnce

    # Data volume
    data:
      enabled: true
      existingClaim: ""
      size: 30Gi
      storageClass: ""
      accessMode: ReadWriteOnce

  # ===================================================================
  # CONFIGURATION
  # ===================================================================

  config:
    # UI theme
    theme: "owncloud"
    # App registry configuration (optional)
    appRegistry: {}
    # Content Security Policy (optional)
    csp: {}
    # Proxy role mapping configuration (optional)
    # Used to map OIDC groups to OpenCloud roles
    proxy: {}
    # Banned password list (one per line)
    bannedPasswordList: |-

  # ===================================================================
  # NATS MESSAGING
  # ===================================================================

  nats:
    external:
      # Use external NATS cluster (recommended for production)
      enabled: false
      endpoint: nats.opencloud-nats.svc.cluster.local:4222
      cluster: opencloud-cluster
      tls:
        enabled: false
        certTrusted: true
        insecure: false
        # Secret containing ca.crt (only used if certTrusted: false)
        caSecretName: opencloud-nats-ca

  # ===================================================================
  # EMAIL (SMTP)
  # ===================================================================

  smtp:
    enabled: false
    host: ""
    port: "587"
    sender: ""
    # Use existingSecret for credentials
    # Secret must contain keys: smtpUser, smtpPassword
    existingSecret: ""
    username: ""
    password: ""
    insecure: "false"
    authentication: "plain"
    encryption: "starttls"

  # ===================================================================
  # STORAGE BACKEND
  # ===================================================================

  storage:
    # Storage mode: "s3" or "posixfs"
    mode: s3

    # S3-compatible storage (MinIO, AWS S3, Ceph, etc.)
    s3:
      external:
        # REQUIRED when mode: s3
        enabled: false
        # S3 endpoint URL (e.g., https://s3.amazonaws.com or https://minio.example.com)
        endpoint: ""
        region: "default"
        # Use existingSecret for credentials
        # Secret must contain keys: accessKey, secretKey
        existingSecret: ""
        accessKey: ""
        secretKey: ""
        bucket: ""
        # Auto-create bucket if it doesn't exist
        createBucket: true

    # POSIX filesystem storage
    posixfs:
      # Cache store: 'memory', 'redis-sentinel', 'nats-js-kv', 'noop'
      idCacheStore: nats-js-kv
      # Root storage directory
      rootPath: "/var/lib/opencloud/storage"
      persistence:
        enabled: true
        existingClaim: ""
        size: 30Gi
        storageClass: ""
        # ReadWriteMany required for multiple replicas
        accessMode: ReadWriteMany

# =====================================================================
# INGRESS
# =====================================================================

ingress:
  # Enable ingress resources
  enabled: false

  # Ingress class (e.g., nginx, traefik)
  ingressClassName: ""

  # Annotations for all ingress resources
  annotations: {}
    # Example for cert-manager:
    # cert-manager.io/cluster-issuer: letsencrypt-prod
    # Example for nginx:
    # nginx.ingress.kubernetes.io/proxy-body-size: "0"
